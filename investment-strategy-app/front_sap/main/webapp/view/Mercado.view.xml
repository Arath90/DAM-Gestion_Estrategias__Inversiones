<mvc:View controllerName="main.controller.Mercado"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.f"
    xmlns:m="sap.m"
    xmlns:core="sap.ui.core">
    <DynamicPage id="marketDynamicPage" toggleHeaderOnTitleClick="false" class="appDynamicPage">
        <title>
            <DynamicPageTitle>
                <heading>
                    <m:Title text="Mercado" level="H2" />
                </heading>
                <actions>
                    <m:Button icon="sap-icon://hint"
                        type="Transparent"
                        tooltip="Ver glosario y ayuda de mercado"
                        press="onOpenMarketHelp" />
                    <m:Button icon="sap-icon://refresh"
                        type="Transparent"
                        tooltip="Actualizar datos"
                        press="onRefresh" />
                </actions>
            </DynamicPageTitle>
        </title>
        <content>
            <m:VBox id="marketContent" class="appContentContainer sapUiResponsiveMargin" width="100%">
                <m:Text text="Monitorea curvas de mercado, indicadores y volumen en tiempo real." class="marketIntroText" />
                <m:MessageStrip id="marketMessageStrip"
                    visible="{= !!${market>/error}}"
                    text="{market>/error}"
                    type="Error"
                    showIcon="true"
                    class="sapUiSmallMarginTop" />

                <m:Panel headerText="Configuracion" class="sapUiSmallMarginTop marketConfigPanel" expandable="false">
                    <m:VBox class="marketConfigBox">
                        <m:HBox class="marketInstrumentRow" wrap="Wrap" alignItems="Center" justifyContent="SpaceBetween">
                            <m:VBox class="marketFieldGroup">
                                <m:Label text="Instrumento rapido"
                                    tooltip="Selecciona un ticker frecuente."
                                    labelFor="marketPresetSelect" />
                                <m:Select id="marketPresetSelect"
                                    width="16rem"
                                    selectedKey="{market>/presetKey}"
                                    change="onPresetChange"
                                    items="{market>/presets}">
                                    <m:items>
                                        <m:SelectItem key="{market>value}" text="{market>label}" />
                                    </m:items>
                                </m:Select>
                            </m:VBox>
                            <m:VBox class="marketFieldGroup">
                                <m:Label text="Ticker personalizado"
                                    tooltip="Ingresa un ticker manual (por ejemplo TSLA) y presiona cargar."
                                    labelFor="marketCustomInput" />
                                <m:HBox alignItems="Center" class="marketCustomInput">
                                    <m:Input id="marketCustomInput"
                                        width="12rem"
                                        value="{market>/customTicker}"
                                        liveChange="onCustomTickerChange"
                                        placeholder="Ej. TSLA"
                                        maxLength="20" />
                                    <m:Button text="Cargar" type="Emphasized" press="onLoadCustomTicker" />
                                </m:HBox>
                            </m:VBox>
                            <m:VBox class="marketFieldGroup">
                                <m:Label text="Intervalos"
                                    tooltip="Selecciona el intervalo de velas."
                                    labelFor="marketIntervalSegment" />
                                <m:SegmentedButton id="marketIntervalSegment"
                                    selectedKey="{market>/interval}"
                                    selectionChange="onIntervalChange"
                                    items="{market>/intervals}">
                                    <m:items>
                                        <m:SegmentedButtonItem key="{market>value}" text="{market>label}" />
                                    </m:items>
                                </m:SegmentedButton>
                            </m:VBox>
                        </m:HBox>
                        <m:HBox class="marketSwitchRow sapUiSmallMarginTop" wrap="Wrap" alignItems="Center">
                            <m:CheckBox text="EMA20"
                                selected="{market>/settings/ema20}"
                                tooltip="Media movil exponencial de 20 periodos."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="ema20" />
                                </m:customData>
                            </m:CheckBox>
                            <m:CheckBox text="EMA50"
                                selected="{market>/settings/ema50}"
                                tooltip="Media movil exponencial de 50 periodos."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="ema50" />
                                </m:customData>
                            </m:CheckBox>
                            <m:CheckBox text="SMA200"
                                selected="{market>/settings/sma200}"
                                tooltip="Media movil simple de 200 periodos."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="sma200" />
                                </m:customData>
                            </m:CheckBox>
                            <m:CheckBox text="Volumen"
                                selected="{market>/settings/volume}"
                                tooltip="Histograma de volumen bajo el grafico principal."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="volume" />
                                </m:customData>
                            </m:CheckBox>
                            <m:CheckBox text="RSI"
                                selected="{market>/settings/rsi}"
                                tooltip="Oscilador de fuerza relativa (14 periodos)."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="rsi" />
                                </m:customData>
                            </m:CheckBox>
                            <m:CheckBox text="Senales"
                                selected="{market>/settings/signals}"
                                tooltip="Marcadores de compra/venta generados por cruces EMA y RSI."
                                select="onToggleSetting">
                                <m:customData>
                                    <core:CustomData key="settingKey" value="signals" />
                                </m:customData>
                            </m:CheckBox>
                        </m:HBox>
                    </m:VBox>
                </m:Panel>

                <m:Panel headerText="Velas e indicadores" class="sapUiSmallMarginTop marketChartPanel" backgroundDesign="Transparent" expandable="false">
                    <m:VBox class="marketChartContainer">
                        <m:FlexBox class="marketChartShell" direction="Column">
                            <core:HTML id="marketChartCanvas" content="<div class='marketChartCanvas' data-role='main-chart'></div>" />
                            <core:HTML id="marketRsiCanvas" visible="{market>/settings/rsi}" content="<div class='marketChartCanvas marketChartCanvasRsi' data-role='rsi-chart'></div>" />
                            <m:HBox visible="{market>/loading}" class="marketChartOverlay" alignItems="Center" justifyContent="Center">
                                <m:BusyIndicator size="2rem" class="sapUiTinyMarginEnd" />
                                <m:Text text="Cargando datos..." />
                            </m:HBox>
                            <m:HBox visible="{= !!${market>/error} && !${market>/loading}}" class="marketChartOverlay marketChartOverlayError" alignItems="Center" justifyContent="Center">
                                <m:Text text="{market>/error}" />
                            </m:HBox>
                        </m:FlexBox>
                    </m:VBox>
                </m:Panel>

                <m:Panel headerText="Resumen" class="sapUiSmallMarginTop marketSummaryPanel" expandable="false">
                    <m:FlexBox justifyContent="SpaceBetween" wrap="Wrap" class="marketSummaryBox">
                        <m:ObjectStatus title="Ticker" text="{market>/symbol}" />
                        <m:ObjectStatus title="Intervalo" text="{market>/summary/intervalLabel}" />
                        <m:ObjectStatus title="Velas cargadas" text="{market>/summary/candleCount}" />
                        <m:ObjectStatus title="Volumen ultimo" text="{market>/summary/volumeLabel}" />
                    </m:FlexBox>
                </m:Panel>
            </m:VBox>
        </content>
    </DynamicPage>
</mvc:View>
